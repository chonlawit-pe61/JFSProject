@{
    var currentuser = SiteSession.GetCurrentUser();
    var IsSearchCase = (bool)ViewBag.IsSearchCase;
}
<form id="frm">
    <input id="telephone" type="hidden" value="@(currentuser.PhoneNumber)" />
    <input id="memberID" type="hidden" value="@(currentuser.MemberID)" />
    <div class="form-row mt-4 justify-content-md-center">
        <div class="form-group col-md-12 text-center">
            @* <div class="error-groupreq"><div class="form-check form-check-inline ml-3 mt-2">
            <input class="form-check-input icheck" type="radio" name="rdotype" id="rdoTracking" value="2" checked>
            <label class="form-check-label pl-2" for="rdoTracking">ติดตามผลพิจารณา</label>
        </div>
        <div class="form-check form-check-inline ml-3 mt-2">
            <input class="form-check-input icheck" type="radio" name="rdotype" id="rdoClaim" value="1">
            <label class="form-check-label pl-2" for="rdoClaim">ขอสิทธิ์ยืนยันรายงานผลโครงการที่ไม่ได้ยื่นออนไลน์</label>
        </div> </div>*@

            <input type="hidden" value="@(IsSearchCase? 1:0)" id="IsSearchCase" />
            @if (IsSearchCase)
            {
                <h4>ติดตามผลพิจารณา</h4>
            }
            else
            {
                <h4>ขอสิทธิ์ยืนยันรายงานผลโครงการที่ไม่ได้ยื่นออนไลน์</h4>
            }
        </div>
        <div class="form-group col-md-6">
            <div class="input-group input-group-sm">
                <div class="input-group-prepend"><label for="jfcaseNO" class="pr-2">เลขที่ กทย. </label></div>
                <input type="text" maxlength="10" class="form-control validate[required]" id="jfcaseNO" value="@(Request["caseno"])" autocomplete="off" placeholder="กทxxxx/xx">
                <div class="input-group-append">
                    <button type="button" class="btn btn-primary" id="btsearch">ค้นหา</button>
                </div>
            </div>
        </div>
    </div>
    <div id="result" class="mt-3 "></div>


</form>
@section scripts{

    <script type="text/javascript">
        var caseno = Common.getParameterByName("caseno");
        //if (caseno != null && caseno != '') {
        //    console.log(caseno);
        //    window.history.pushState(null, null, window.location.pathname + '?caseno=' + caseno);
        //    gettracking(caseno);
        //}
        $(document).ready(function () {
            $('.icheck').iCheck({
                checkboxClass: 'icheckbox_flat-grey',
                radioClass: 'iradio_flat-grey'
            });

            $('body')
                .off('click', '#btsearch')
                .on('click', '#btsearch', function () {
                    if ($('#jfcaseNO').length) {
                        caseno = $('#jfcaseNO').val();
                    } else {
                        caseno = Common.getParameterByName("caseno");
                    }
                    if (caseno != '')
                        window.history.pushState(null, null, window.location.pathname + '?caseno=' + caseno);

                    if ($('#IsSearchCase').val() == 0) {
                        //อ้างสิทธิ์เพื่อยื่นรายงาน
                        getClaimcase($('#jfcaseNO').val(), $('#telephone').val());
                    } else {
                       //ติดตามผลพิจารณา
                        gettracking($('#jfcaseNO').val());
                    }
                })
                .off('click', '.js--claim')
                .on('click', '.js--claim', function () {
                    const type = $(this).data('type');
                    const caseID = $(this).closest('.row').data('cid')
                    const applicantID = $(this).closest('.row').data('aid')
                    if (type == 'W') {
                        SWConfirm.fire({ title: 'ส่งให้เจ้าหน้าที่ตรวจสอบ ?', text: 'เนื่องจากเบอร์ไม่ตรงกับเบอร์ที่ลงทะเบียน' }).then((result) => {
                            if (result.value) {
                                Claimcase(caseID, applicantID, type);
                            }
                        });
                    } else {
                        Claimcase(caseID, applicantID, type);
                    }


                });
        });
        function Claimcase(cID,aID, type) {
            $.ajax({
                url: '/claimcase',
                method: 'POST',
                data: { caseID: cID, applicantID:aID, type: type },
                beforeSend: function () { },
                success: function (data) {
                    if (data.Status) {
                        SWSuccess.fire({
                            onClose: () => {
                                window.location.href = "/form";
                            }
                        });
                    }
                }
                , error: function (err) {
                    console.log(err);
                }
            });
        }
        function getClaimcase(caseno, phonenumber) {
            $.ajax({
                url: '/getcase',
                method: 'POST',
                data: { caseNo: caseno, phoneNumber: phonenumber },
                beforeSend: function () { },
                success: function (data) {
                    if (data.Status) {
                        var template = Handlebars.compile($('#tmpl-list').html());
                        $('#result').html(template({ data: data.Data, type: data.DataID }));
                        setTimeout(function () {
                            $('.icheck').iCheck({
                                checkboxClass: 'icheckbox_flat-grey',
                                radioClass: 'iradio_flat-grey'
                            });
                        }, 30)
                    } else {
                        let elestr = '<div class="text-center text-danger h4">' + data.Message + '</div>';
                        $('#result').html(elestr);
                    }
                }
                , error: function (err) {
                    console.log(err);
                }
            });
        }
        function gettracking(caseno) {
            tbody = $('#result');
            $.ajax({
                url: '/api/gettrackingresult',
                method: 'POST',
                data: { id: caseno },
                beforeSend: function () { },
                success: function (data) {
                    if (data.Result.Status) {
                        if (data.Result.Data.length != 0) {
                            var template = Handlebars.compile($('#tmpl-tracklist').html());
                            tbody.html(template(data.Result.Data));
                        } else {
                            tbody.html('<div class="text-center text-danger h4">ไม่พบข้อมูลที่ค้นหา</div>');
                        }
                    } else {
                        let elestr = '<div class="text-center text-danger h4">' + data.Result.Message + '</div>';
                        tbody.html(elestr);
                    }
                }
                , error: function (err) {
                    console.log(err);
                }
            });

            //SWConfirm.fire().then((result) => {
            //    if (result.value) {
            //        SWSuccess.fire()
            //    }
            //});



        }
    </script>
    <script id="tmpl-list" type="text/x-handlebars-template">
        <div class="row p-3 border" data-cid="{{data.CaseID}}" data-aid="{{data.ApplicantID}}">
            <div class="col-md-9">
                <div class="h5">
                    {{data.Subject}}
                </div>
                <div>ผู้ยื่น : <span>{{data.Title}}{{data.FirstName}} {{data.LastName}}</span><span class="float-right">เจ้าหน้าที่ผู้รับผิดชอบสำนวน : {{data.LawyerFirstName}} {{data.LawyerLastName}}</span></div>
                <div><span>เลขที่ กทย. : {{data.JFCaseNo}}</span> <span>สถานะ : {{data.WorkStepName}}</span><span class="float-right">วันที่สร้าง : {{JSONDateWithTimeThai data.CreateDate}}</span></div>
            </div>
            <div class="col-md-3 pt-4 text-center">
                {{#ifCond type "==" 1 }}
                <a href="javascript:void(0)" class="badge badge-pill badge-primary js--claim" data-type="C">อ้างสิทธิ์</a>
                {{else}}
                {{#ifCond type "==" 2 }}

                <a href="javascript:void(0)" class="badge badge-pill badge-warning js--claim" data-type="W">อ้างสิทธิ์</a>
                {{else}}
                {{#ifCond type "==" 4 }}

                <div>รอเจ้าหน้าที่ตรวจสอบ</div>
                {{else}}
                <div>อ้างสิทธ์แล้ว</div>
                {{/ifCond}}
                {{/ifCond}}
                {{/ifCond}}
            </div>
        </div>
    </script>
    <script id="tmpl-tracklist" type="text/x-handlebars-template">

        <div class="main-card mb-3 card">
            <div class="card-body">
                <h5 class="card-title">สถานะ</h5>
                <div class="vertical-time-simple vertical-without-time vertical-timeline vertical-timeline--animate vertical-timeline--one-column">

                    {{#each this}}
                    <div class="vertical-timeline-item vertical-timeline-element">
                        <div>
                            <span class="vertical-timeline-element-icon bounce-in"></span>
                            <div class="vertical-timeline-element-content bounce-in">
                                {{#if DataJudgeResult}}
                                <h4 class="timeline-title text-primary"><span class="text-success">{{{DataJudgeResult.JudgeDate}}}</span> {{{DataJudgeResult.Message}}}</h4>

                                {{/if}}

                                <h4 class="timeline-title">
                                    <span class="text-success">{{ProcessDate}}</span>
                                    {{Message}}
                                </h4>
                                {{#each SubProcess}}<p class="pl-3 text-dark"><span class="small font-italic">{{{ProcessDate}}}</span> {{{Status}}} </p> {{/each}}
                            </div>

                        </div>
                    </div>
                    {{/each}}
                    @*<div class="vertical-timeline-item vertical-timeline-element">
                            <div>
                                <span class="vertical-timeline-element-icon bounce-in"></span>
                                <div class="vertical-timeline-element-content bounce-in"><p>Yet another one, at <span class="text-success">15:00 PM</span></p></div>
                            </div>
                        </div>
                        <div class="vertical-timeline-item vertical-timeline-element">
                            <div>
                                <span class="vertical-timeline-element-icon bounce-in"></span>
                                <div class="vertical-timeline-element-content bounce-in"><h4 class="timeline-title">Build the production release</h4></div>
                            </div>
                        </div>
                        <div class="vertical-timeline-item vertical-timeline-element">
                            <div>
                                <span class="vertical-timeline-element-icon bounce-in"></span>
                                <div class="vertical-timeline-element-content bounce-in"><h4 class="timeline-title text-success">Something not important</h4></div>
                            </div>
                        </div>*@
                </div>
            </div>
        </div>
    </script>
}